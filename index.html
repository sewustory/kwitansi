<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kostory Invoice v9 — Login + Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;margin:0;padding:15px;background:#f4f6f9;}
  .container{max-width:1200px;margin:auto;display:flex;gap:20px;flex-wrap:wrap;}
  .form{width:420px;background:white;padding:25px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15);position:sticky;top:15px;height:fit-content;}
  h1{font-size:26px;color:#e67e22;text-align:center;margin-bottom:20px;}
  label{display:block;margin:14px 0 6px;font-weight:bold;}
  input,select{width:100%;padding:11px;border:1px solid #ccc;border-radius:8px;font-size:14px;}
  button{padding:11px 16px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-top:8px;}
  .btn-primary{background:#e67e22;color:white;width:100%;font-size:16px;}
  .btn-warning{background:#f39c12;color:white;}
  .auto-no{font-size:18px;font-weight:bold;color:#e67e22;background:#fff8e1;padding:12px;border-radius:8px;text-align:center;margin:15px 0;}
  .history-section{margin-top:50px;width:100%;}
  .history-table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
  .history-table th{background:#e67e22;color:white;padding:14px;text-align:left;}
  .history-table td{padding:12px 10px;border-bottom:1px solid #eee;}
  .history-table tr:hover{background:#fff8e1;}
  #printArea{display:none;}
  @media print{body{background:white;padding:0;}.form,.history-section{display:none!important;}#printArea{display:block!important;padding:50px 70px;font-size:14.5px;}}
</style>
</head>
<body>

<div class="container">
  <div class="form">
    <h1>Kostory Invoice v9</h1>
    <label>Pilih Pelanggan</label>
    <select id="pelangganSelect" onchange="pilihPelanggan()"></select>
    <button onclick="tambahPelangganBaru()">+ Baru</button>

    <label>Perusahaan</label><input type="text" id="perusahaan">
    <label>Kota</label><input type="text" id="kota">
    <label>No. HP</label><input type="text" id="hp">
    <label>PIC</label><input type="text" id="pic">

    <hr style="margin:25px 0;border:1px dashed #ddd;">
    <div class="auto-no">No. Faktur: <span id="autoNo">2511001</span></div>

    <label>Tanggal Faktur</label><input type="date" id="tglFaktur" value="2025-11-28">
    <label>Jatuh Tempo</label><input type="date" id="jatuhTempo" value="2025-12-30">

    <select id="tipe">
      <option>Single Bed Standard</option>
      <option selected>Double Bed Standard</option>
      <option>Twin Bed Standard</option>
      <option>Single Bed Xtra Service</option>
      <option>Double Bed Xtra Service</option>
      <option>Twin Bed Xtra Service</option>
    </select>

    <label>Nama Kamar</label><input type="text" id="kamar" value="MEKAR 208">
    <label>Check-in</label><input type="date" id="in" value="2025-11-01">
    <label>Check-out</label><input type="date" id="out" value="2025-12-01">

    <label style="color:#e67e22;font-size:16px;">Total Tagihan</label>
    <input type="number" id="tagihan" value="1950000" style="font-size:22px;color:#e67e22;font-weight:bold;">

    <label>Jumlah Dibayar</label><input type="number" id="bayar" value="0">
    <label>Tanggal Bayar</label><input type="date" id="tglBayar">

    <label>Pilih Rekening</label>
    <select id="pilihRekening"></select>
    <button onclick="tambahRekening()">+ Tambah Rekening</button>

    <button class="btn-primary" onclick="simpanPelanggan();simpanKeHistory();window.print()">Cetak Faktur</button>
    <button class="btn-warning" onclick="logout()">Logout</button>
  </div>
</div>

<div class="history-section">
  <h2 style="color:#e67e22;">Riwayat Faktur (2 Bulan Terakhir)</h2>
  <table class="history-table" id="historyTable">
    <thead><tr><th>No</th><th>Tanggal</th><th>Perusahaan</th><th>PIC</th><th>HP</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="printArea">
  <div style="text-align:center;margin-bottom:40px;">
    <h1 style="font-size:58px;color:#e67e22;margin:0;letter-spacing:-3px;">Kostory</h1>
    <p style="margin:5px 0 0;font-size:11px;letter-spacing:2px;color:#555;">WHERE STORIES FIND HOME</p>
  </div>
  <p style="text-align:center;font-size:18px;"><strong>FAKTUR # <span id="p-no">2511001</span></strong></p>
  <p style="text-align:center;">Tanggal: <span id="p-tgl">28 November 2025</span> | Jatuh Tempo: <span id="p-tempo">30 Desember 2025</span></p>
  <p><strong>DITAGIH KEPADA:</strong><br>
     <span id="p-perusahaan">PT. CONTOH</span> - <span id="p-kota">PALEMBANG</span><br>
     PIC: <span id="p-pic">Budi</span> | HP: <span id="p-hp">0812xxx</span>
  </p>
  <p>Keterangan: Kost <span id="p-tipe">Double Bed Standard</span> - <strong><span id="p-kamar">MEKAR 208</span></strong><br>
     Periode: <span id="p-periode">1 Nov - 1 Des 2025</span>
  </p>
  <p style="font-size:20px;text-align:right;margin:40px 0;">
    <strong>Total Tagihan: Rp<span id="p-total">1.950.000</span></strong>
  </p>
  <p style="text-align:right;">Palembang, <span id="p-tgl2">28 November 2025</span></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, getDocs, query, where, orderBy, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// GANTI INI DOANG — copy dari Firebase Console → Project Settings → Web App
const firebaseConfig = {
  apiKey: "AIzaSyDaFM8dTqOn6c875Xe3VIfYkz4O1ioOLxA",
  authDomain: "nota-1596b.firebaseapp.com",
  projectId: "nota-1596b",
  storageBucket: "nota-1596b.firebasestorage.app",
  messagingSenderId: "921988782142",
  appId: "1:921988782142:web:ac633cf89b0b002df5196f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pelangganCol = collection(db, "pelanggan");
const rekeningCol  = collection(db, "rekening");
const historyCol   = collection(db, "history");
const counterDoc   = doc(db, "meta", "counter");

// Cek login sederhana (username + pass disimpan di localStorage)
const validUsers = {
  "admin":"ramenuno20","mekar":"kopipait69","satria":"cilukba123",
  "mitra":"ayamgeprek77","ecocost":"mirebus08","mitraya":"odading88",
  "bukit":"nasiuduk21","inaya":"rempeyek12"
};

if (!validUsers[localStorage.getItem("kostory_user")]) {
  alert("Harap login terlebih dahulu!");
  location.href = "login.html";
}

window.logout = () => {
  localStorage.removeItem("kostory_user");
  location.href = "login.html";
};

// Auto nomor faktur
async function getNoFaktur() {
  const snap = await getDoc(counterDoc);
  let n = snap.exists() ? snap.data().no || 0 : 0;
  n++;
  await setDoc(counterDoc, { no: n }, { merge: true });
  const no = "25" + String(n).padStart(5, "0");
  document.getElementById("autoNo").textContent = no;
  document.getElementById("p-no").textContent = no;
}

// Load pelanggan
async function loadPelanggan() {
  const sel = document.getElementById("pelangganSelect");
  sel.innerHTML = "<option>-- Pilih Pelanggan --</option>";
  const q = query(pelangganCol, orderBy("perusahaan"));
  const snap = await getDocs(q);
  snap.forEach(d => sel.add(new Option(d.data().perusahaan, d.id)));
}

// Pilih pelanggan
window.pilihPelanggan = async () => {
  const id = document.getElementById("pelangganSelect").value;
  if (!id) return;
  const snap = await getDoc(doc(db, "pelanggan", id));
  if (snap.exists()) {
    const p = snap.data();
    document.getElementById("perusahaan").value = p.perusahaan || "";
    document.getElementById("kota").value = p.kota || "";
    document.getElementById("hp").value = p.hp || "";
    document.getElementById("pic").value = p.pic || "";
  }
  updatePrint();
};

// Simpan pelanggan
window.simpanPelanggan = async () => {
  const data = {
    perusahaan: document.getElementById("perusahaan").value.trim(),
    kota: document.getElementById("kota").value.trim(),
    hp: document.getElementById("hp").value.trim(),
    pic: document.getElementById("pic").value.trim()
  };
  if (!data.perusahaan) return alert("Isi nama perusahaan!");
  const q = query(pelangganCol, where("perusahaan", "==", data.perusahaan));
  const existing = await getDocs(q);
  if (!existing.empty) {
    await setDoc(existing.docs[0].ref, data);
  } else {
    await addDoc(pelangganCol, data);
  }
  loadPelanggan();
};

window.tambahPelangganBaru = () => {
  document.getElementById("pelangganSelect").value = "";
  ["perusahaan","kota","hp","pic"].forEach(id => document.getElementById(id).value = "");
};

// Rekening
async function loadRekening() {
  const sel = document.getElementById("pilihRekening");
  sel.innerHTML = "";
  const snap = await getDocs(rekeningCol);
  snap.forEach((d, i) => sel.add(new Option(`${d.data().nama} - ${d.data().nomor}`, i)));
}
window.tambahRekening = () => {
  const nama = prompt("Nama Bank:");
  const nomor = prompt("Nomor Rekening:");
  const an = prompt("Atas Nama:");
  if (nama && nomor && an) addDoc(rekeningCol, {nama, nomor, atasNama: an}).then(loadRekening);
};

// Update print preview
function updatePrint() {
  const t = v => document.getElementById(v).value;
  const f = n => Number(n).toLocaleString("id-ID");
  document.getElementById("p-perusahaan").textContent = t("perusahaan").toUpperCase();
  document.getElementById("p-kota").textContent = t("kota");
  document.getElementById("p-hp").textContent = t("hp");
  document.getElementById("p-pic").textContent = t("pic");
  document.getElementById("p-tipe").textContent = document.getElementById("tipe").value;
  document.getElementById("p-kamar").textContent = t("kamar");
  document.getElementById("p-periode").textContent = t("in") + " - " + t("out");
  document.getElementById("p-tgl").textContent = new Date(t("tglFaktur")).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
  document.getElementById("p-tempo").textContent = new Date(t("jatuhTempo")).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
  document.getElementById("p-total").textContent = f(t("tagihan"));
}

// Simpan ke history
window.simpanKeHistory = async () => {
  await addDoc(historyCol, {
    no: document.getElementById("autoNo").textContent,
    tgl: document.getElementById("tglFaktur").value,
    perusahaan: document.getElementById("perusahaan").value,
    pic: document.getElementById("pic").value,
    hp: document.getElementById("hp").value,
    created: serverTimestamp()
  });
  loadHistory();
};

// Load history
async function loadHistory() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
  const duaBulan = new Date(); duaBulan.setMonth(duaBulan.getMonth() - 2);
  const q = query(historyCol, where("tgl", ">=", duaBulan.toISOString().split("T")[0]), orderBy("tgl", "desc"));
  const snap = await getDocs(q);
  tbody.innerHTML = "";
  snap.forEach(d => {
    const h = d.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${h.no}</td><td>${new Date(h.tgl).toLocaleDateString("id-ID")}</td><td>${h.perusahaan}</td><td>${h.pic}</td><td>${h.hp}</td>`;
    tbody.appendChild(tr);
  });
}

// Init
getNoFaktur();
loadPelanggan();
loadRekening();
loadHistory();
document.querySelectorAll("input,select").forEach(el => el.addEventListener("input", updatePrint));
updatePrint();
</script>
</body>
</html>

