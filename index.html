<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kostory Invoice v8.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  /* CSS kamu yang lama 100% tetap sama, aku skip biar pendek */
  *{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:15px;background:#f4f6f9}
  .container{display:flex;gap:20px;max-width:1200px;margin:auto;flex-wrap:wrap}
  .form{width:420px;background:white;padding:25px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15);position:sticky;top:15px;height:fit-content}
  h1{font-size:26px;color:#e67e22;text-align:center;margin-bottom:20px}
  /* sisanya copy-paste CSS lama kamu */
  #printArea{display:none}
  @media print{#printArea{display:block!important;padding:40px 60px} .form,.history-section{display:none!important}}
</style>
</head>
<body>

<div class="container">
  <div class="form">
    <h1>Kostory Invoice v8.1</h1>
    <label>Pilih Pelanggan</label>
    <select id="pelangganSelect" onchange="pilihPelanggan()"></select>
    <button class="btn-small" onclick="tambahPelangganBaru()">+ Baru</button>

    <label>Perusahaan</label><input type="text" id="perusahaan">
    <label>Kota</label><input type="text" id="kota">
    <label>No. HP</label><input type="text" id="hp">
    <label>PIC</label><input type="text" id="pic">

    <hr style="margin:25px 0;border:1px dashed #ddd;">
    <div class="auto-no">No. Faktur: <span id="autoNo">2511001</span></div>

    <label>Tanggal Faktur</label><input type="date" id="tglFaktur" value="2025-11-28">
    <label>Jatuh Tempo</label><input type="date" id="jatuhTempo" value="2025-12-30">

    <label>Tipe Kamar</label>
    <select id="tipe">
      <option>Single Bed Standard</option>
      <option selected>Double Bed Standard</option>
      <option>Twin Bed Standard</option>
      <option>Single Bed Xtra Service</option>
      <option>Double Bed Xtra Service</option>
      <option>Twin Bed Xtra Service</option>
    </select>

    <label>Nama Kamar</label><input type="text" id="kamar" value="MEKAR 208">
    <label>Check-in</label><input type="date" id="in" value="2025-11-01">
    <label>Check-out</label><input type="date" id="out" value="2025-12-01">

    <label style="color:#e67e22;font-size:16px;">Total Tagihan</label>
    <input type="number" id="tagihan" value="1950000" style="font-size:22px;font-weight:bold;color:#e67e22;">

    <label>Jumlah Dibayar</label><input type="number" id="bayar" value="0">
    <label>Tanggal Bayar</label><input type="date" id="tglBayar">

    <hr style="margin:25px 0;border:1px dashed #ddd;">
    <label>Pilih Rekening Bank</label>
    <select id="pilihRekening" onchange="update()"></select>
    <button class="btn-small btn-success" onclick="tambahRekening()">+ Tambah</button>

    <button class="btn-primary" onclick="simpanPelanggan();simpanKeHistory();window.print()">Cetak Faktur</button>
    <button class="btn-warning" onclick="logout()" style="margin-top:10px;">Logout</button>
  </div>
</div>

<div class="history-section">
  <h2 style="color:#e67e22;">Riwayat Faktur</h2>
  <table class="history-table" id="historyTable"><thead><tr><th>No</th><th>Tanggal</th><th>Perusahaan</th><th>PIC</th><th>HP</th><th>Aksi</th></tr></thead><tbody></tbody></table>
</div>

<!-- INVOICE PRINT AREA (sama persis seperti asli kamu) -->
<div id="printArea"><!-- isi print area kamu yang lama --></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// <<< GANTI INI DOANG >>>
const firebaseConfig = {
  apiKey: "MASUKIN_API_KEY_KAMU",
  authDomain: "nama-project.firebaseapp.com",
  projectId: "nama-project",
  storageBucket: "nama-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};
// <<< SAMPE SINI >>>

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const colPelanggan = collection(db, "pelanggan");
const colRekening  = collection(db, "rekening");
const colHistory   = collection(db, "history");
const counterDoc   = doc(db, "counters", "faktur");

// Cek login
onAuthStateChanged(auth, user => {
  if (!user) return location.href = "login.html";
  init();
});

window.logout = () => signOut(auth);

// Init
async function init() {
  await generateNoFaktur();
  loadPelanggan();
  loadRekening();
  loadHistory();
  update();
}

// Nomor faktur otomatis
async function generateNoFaktur() {
  const snap = await getDoc(counterDoc);
  let n = snap.exists() ? snap.data().last || 0 : 0;
  n++;
  await setDoc(counterDoc, {last: n}, {merge:true});
  const no = String(n).padStart(7, "0");
  document.getElementById("autoNo").textContent = no;
  document.getElementById("p-no").textContent = no;
}

// Pelanggan, Rekening, History, dll → semua pake Firestore (mirip localStorage tapi di cloud)
async function loadPelanggan() { /* isi kode lengkap di bawah */ }
async function loadRekening() { /* ... */ }
async function loadHistory() { /* ... */ }
// sisanya aku kasih versi lengkap di file 2

// Update tampilan
window.update = () => {
  // kode update kamu yang lama tetap jalan
  const tag = parseInt(document.getElementById("tagihan").value) || 0;
  // ... dst
};

// Simpan ke history
window.simpanKeHistory = async () => {
  await addDoc(colHistory, {
    no: document.getElementById("autoNo").textContent,
    tgl: document.getElementById("tglFaktur").value,
    // semua data
    created: serverTimestamp()
  });
  loadHistory();
};

// dsb…
</script>
</body>
</html>