<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kostory Invoice v8.1 — TANPA PREVIEW DI LAYAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  * {box-sizing:border-box;}
  body {font-family:Arial,sans-serif;margin:0;padding:15px;background:#f4f6f9;}
  .container {display:flex;gap:20px;max-width:1200px;margin:auto;flex-wrap:wrap;}
  
  .form {
    width:420px;background:white;padding:25px;border-radius:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.15);position:sticky;top:15px;
    height:fit-content;z-index:999;align-self:flex-start;
  }

  h1 {font-size:26px;color:#e67e22;text-align:center;margin-bottom:20px;}
  label {display:block;margin:14px 0 6px;font-weight:bold;font-size:14px;}
  input,select{width:100%;padding:11px;border:1px solid #ccc;border-radius:8px;font-size:14px;}
  button{padding:11px 16px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-top:8px;}
  .btn-primary{background:#e67e22;color:white;width:100%;font-size:16px;}
  .btn-success{background:#27ae60;color:white;}
  .btn-info{background:#3498db;color:white;font-size:13px;}
  .btn-warning{background:#f39c12;color:white;font-size:13px;}
  .btn-small{padding:7px 12px;font-size:13px;margin-left:8px;}
  .auto-no{font-size:18px;font-weight:bold;color:#e67e22;background:#fff8e1;padding:12px;border-radius:8px;text-align:center;margin:15px 0;}
  .backup-box{margin:20px 0;padding:15px;background:#e8f5e9;border-radius:8px;border:2px solid #27ae60;font-size:14px;}
  .rekening-list{max-height:180px;overflow-y:auto;margin-top:10px;padding:8px;background:#f9f9f9;border-radius:8px;}

  /* HISTORY */
  .history-section{margin-top:50px;width:100%;}
  .history-table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
  .history-table th{background:#e67e22;color:white;padding:14px;text-align:left;}
  .history-table td{padding:12px 10px;border-bottom:1px solid #eee;cursor:pointer;}
  .history-table tr:hover{background:#fff8e1;}
  .history-table tr:last-child td{border-bottom:none;}
  .action-btn{padding:5px 10px;margin:0 4px;border:none;border-radius:6px;color:white;cursor:pointer;font-size:12px;}
  .btn-wa{background:#25d366;}
  .btn-delete{background:#e74c3c;}

  /* INVOICE — HANYA MUNCUL SAAT PRINT */
  #printArea {display:none;}

  @media print {
    body {background:white;padding:0;margin:0;}
    .form, .backup-box, .history-section {display:none!important;}
    #printArea {display:block!important;padding:40px 60px;}
    .invoice {max-width:800px;margin:auto;font-size:14.5px;line-height:1.75;color:#000;}
    .header {display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;}
    .logo{position:relative;}
    .logo-circle{width:82px;height:82px;background:#ffca28;border-radius:50%;position:absolute;top:-12px;left:-12px;}
    .logo-text{font-size:58px;font-weight:900;letter-spacing:-2.8px;position:relative;z-index:2;}
    .tagline{font-size:10.8px;color:#555;margin-top:-6px;letter-spacing:1.2px;font-weight:600;}
    .company{text-align:right;font-size:12.5px;line-height:1.75;}
    .info{background:#f0f0f0;padding:16px 22px;border-radius:8px;display:flex;justify-content:space-between;margin:35px 0 40px;}
    table{width:100%;border-collapse:collapse;margin:30px 0;}
    th{background:#f8f8f8;padding:14px 10px;font-weight:bold;border-bottom:3px double #000;}
    td{padding:14px 10px;border-bottom:1px solid #ddd;vertical-align:top;}
    .text-right{text-align:right;}
    .text-center{text-align:center;}
    .total-section{float:right;width:380px;margin-top:40px;font-size:15px;}
    .total-line{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #ddd;}
    .big-total{background:#f5f5f5;padding:16px;text-align:center;font-size:22px;font-weight:bold;border:2px solid #000;border-radius:8px;margin-top:15px;}
    .payment-section{margin-top:100px;clear:both;}
    .rekening{white-space:pre-line;line-height:1.8;font-size:14.5px;}
    .notes{margin-top:30px;font-size:13.5px;line-height:1.85;}
  }
</style>
</head>
<body>

<div class="container">
  <!-- FORM -->
  <div class="form">
    <h1>Kostory Invoice v8.1</h1>

    <label>Pilih Pelanggan</label>
    <select id="pelangganSelect" onchange="pilihPelanggan()"></select>
    <button class="btn-small" onclick="tambahPelangganBaru()">+ Baru</button>

    <label>Perusahaan</label>
    <input type="text" id="perusahaan">

    <label>Kota</label>
    <input type="text" id="kota">

    <label>No. HP</label>
    <input type="text" id="hp">

    <label>PIC</label>
    <input type="text" id="pic">

    <hr style="margin:25px 0;border:1px dashed #ddd;">

    <div class="auto-no">No. Faktur: <span id="autoNo">2511001</span></div>

    <label>Tanggal Faktur</label>
    <input type="date" id="tglFaktur" value="2025-11-28">
    <label>Jatuh Tempo</label>
    <input type="date" id="jatuhTempo" value="2025-12-30">

    <label>Tipe Kamar</label>
    <select id="tipe">
      <option>Single Bed Standard</option>
      <option selected>Double Bed Standard</option>
      <option>Twin Bed Standard</option>
      <option>Single Bed Xtra Service</option>
      <option>Double Bed Xtra Service</option>
      <option>Twin Bed Xtra Service</option>
    </select>

    <label>Nama Kamar</label>
    <input type="text" id="kamar" value="MEKAR 208">

    <label>Check-in</label><input type="date" id="in" value="2025-11-01">
    <label>Check-out</label><input type="date" id="out" value="2025-12-01">

    <label style="color:#e67e22;font-size:16px;">Total Tagihan</label>
    <input type="number" id="tagihan" value="1950000" style="font-size:22px;font-weight:bold;color:#e67e22;">

    <label>Jumlah Dibayar</label><input type="number" id="bayar" value="0">
    <label>Tanggal Bayar</label><input type="date" id="tglBayar">

    <hr style="margin:25px 0;border:1px dashed #ddd;">
    <label>Pilih Rekening Bank</label>
    <select id="pilihRekening" onchange="update()"></select>
    <button class="btn-small btn-success" onclick="tambahRekening()">+ Tambah</button>
    <div class="rekening-list" id="daftarRekening"></div>

    <button class="btn-primary" onclick="simpanPelanggan();simpanKeHistory();window.print()">Cetak Faktur</button>
    <div class="backup-box">
      <strong>Backup Data</strong><br>
      <button class="btn-info" onclick="exportBackup()">Export Backup</button>
      <button class="btn-warning" onclick="document.getElementById('importFile').click()">Import Backup</button>
      <input type="file" id="importFile" style="display:none;" onchange="importBackup(this.files[0])">
    </div>
  </div>

  <!-- HISTORY -->
  <div class="history-section">
    <h2 style="color:#e67e22;">Riwayat Faktur (2 Bulan Terakhir)</h2>
    <table class="history-table" id="historyTable">
      <thead><tr><th>No</th><th>Tanggal</th><th>Perusahaan</th><th>PIC</th><th>HP</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- PRINT AREA (SAMA PERSIS SEPERTI ASLI KAMU, TIDAK DIRUBAH) -->
<div id="printArea">
  <div class="invoice">
    <div class="header">
      <div class="logo">
        <div class="logo-circle"></div>
        <div class="logo-text">Kostory</div>
        <div class="tagline">WHERE STORIES FIND HOME</div>
      </div>
      <div class="company">
        PT. Kostory Indonesia<br>
        Jl. Contoh No. 123<br>
        Palembang, Sumsel 30114<br>
        Telp: (0711) 123456<br>
        Email: info@kostory.id
      </div>
    </div>
    <div class="info">
      <div>
        <strong>No. Faktur</strong><br>
        <span id="p-no">2511001</span>
      </div>
      <div>
        <strong>Tanggal Faktur</strong><br>
        <span id="p-tgl">28 November 2025</span>
      </div>
      <div>
        <strong>Jatuh Tempo</strong><br>
        <span id="p-tempo">30 Desember 2025</span>
      </div>
    </div>
    <div>
      <strong>DITAGIH KEPADA:</strong><br>
      <span id="p-perusahaan">PT. CONTOH</span><br>
      <span id="p-kota">Palembang</span><br>
      PIC: <span id="p-pic">Budi</span><br>
      HP: <span id="p-hp">0812xxxxxx</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:45%;">Deskripsi</th>
          <th style="width:20%;">Harga</th>
          <th style="width:15%;">Jumlah</th>
          <th style="width:20%;text-align:right;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Kost <span id="p-tipe">Double Bed Standard</span> - <strong><span id="p-kamar">MEKAR 208</strong></span><br>Periode: <span id="p-periode">1 November 2025 SD 1 Desember 2025</span></td>
          <td class="text-center">Rp<span id="p-harga">1.950.000</span></td>
          <td class="text-center"><span id="p-jumlah">1</span></td>
          <td class="text-right">Rp<span id="p-subtotal">1.950.000</span></td>
        </tr>
        <tr>
          <td colspan="3" class="text-right"><strong>Total</strong></td>
          <td class="text-right">Rp<span id="p-total2">1.950.000</span></td>
        </tr>
      </tbody>
    </table>
    <div class="total-section">
      <div class="total-line">
        <span>Dibayar</span>
        <span>Rp<span id="p-bayar">0</span></span>
      </div>
      <div class="total-line">
        <span>Sisa</span>
        <span>Rp<span id="p-sisa">1.950.000</span></span>
      </div>
      <div class="big-total">Rp<span id="p-total">1.950.000</span></div>
    </div>
    <div class="payment-section">
      <strong>PEMBAYARAN</strong><br>
      <span id="p-infoBayar">(Belum ada pembayaran)</span><br>
      <br>
      <strong>Silakan transfer ke:</strong><br>
      <span id="p-rekening">BCA<br>1234567890<br>a/n Kostory Indonesia</span>
    </div>
    <div class="notes">
      <strong>Catatan:</strong><br>
      - Pembayaran dengan cek/giro dianggap sah setelah dicairkan.<br>
      - Faktur ini adalah bukti sah, harap simpan dengan baik.<br>
      - Terima kasih atas kerjasama Anda.
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// GANTI INI DOANG
const firebaseConfig = {
  apiKey: "AIzaSyDaFM8dTqOn6c875Xe3VIfYkz4O1ioOLxA",
  authDomain: "nota-1596b.firebaseapp.com",
  projectId: "nota-1596b",
  storageBucket: "nota-1596b.firebasestorage.app",
  messagingSenderId: "921988782142",
  appId: "1:921988782142:web:ac633cf89b0b002df5196f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const colPelanggan = collection(db, "pelanggan");
const colRekening = collection(db, "rekening");
const colHistory = collection(db, "history");
const colCounter = doc(db, "counters", "monthly");

// Proteksi login (sama seperti asli)
if (!localStorage.getItem("kostory_loggedin")) {
  alert("Silakan login terlebih dahulu!");
  window.location.href = "login.html";
}
function logout() {
  localStorage.removeItem("kostory_loggedin");
  localStorage.removeItem("kostory_user");
  alert("Logout berhasil!");
  window.location.href = "login.html";
}

// Fungsi asli kamu, cuma ganti localStorage -> Firebase
async function loadPelanggan() {
  const s = document.getElementById('pelangganSelect');
  s.innerHTML = '<option>-- Pilih Pelanggan --</option>';
  const q = query(colPelanggan, orderBy("perusahaan"));
  const snap = await getDocs(q);
  snap.forEach(d => {
    const p = d.data();
    const opt = new Option(p.perusahaan, d.id);
    s.appendChild(opt);
  });
}

window.pilihPelanggan = async () => {
  const id = document.getElementById('pelangganSelect').value;
  if (!id) return;
  const docRef = doc(db, "pelanggan", id);
  const snap = await getDoc(docRef);
  if (snap.exists()) {
    const p = snap.data();
    ['perusahaan','kota','hp','pic'].forEach(k => document.getElementById(k).value = p[k] || '');
    update();
  }
};

window.tambahPelangganBaru = () => {
  document.getElementById('pelangganSelect').value = '';
  ['perusahaan','kota','hp','pic'].forEach(id => document.getElementById(id).value = '');
};

async function simpanPelanggan() {
  const data = {
    perusahaan: document.getElementById('perusahaan').value.trim(),
    kota: document.getElementById('kota').value.trim(),
    hp: document.getElementById('hp').value.trim(),
    pic: document.getElementById('pic').value.trim()
  };
  if (!data.perusahaan) return alert("Nama perusahaan wajib diisi!");

  const existing = await getDocs(query(colPelanggan, where("perusahaan", "==", data.perusahaan)));
  if (!existing.empty) {
    await updateDoc(existing.docs[0].ref, data);
  } else {
    await addDoc(colPelanggan, data);
  }
  loadPelanggan();
}

// Rekening
let rekeningList = [];

async function loadRekening() {
  rekeningList = [];
  const sel = document.getElementById('pilihRekening');
  const list = document.getElementById('daftarRekening');
  sel.innerHTML = ''; list.innerHTML = '';

  const snap = await getDocs(colRekening);
  snap.forEach(d => {
    const r = d.data();
    rekeningList.push(r);
    sel.add(new Option(`${r.nama} - ${r.nomor}`, rekeningList.length - 1));
    list.innerHTML += `<div style="display:flex;justify-content:space-between;padding:8px;background:#f9f9f9;margin:5px 0;border-radius:6px;">
      <div><strong>${r.nama}</strong><br>${r.nomor}<br><small>${r.atasNama}</small></div>
      <button style="background:#e74c3c;color:white;border:none;padding:4px 8px;border-radius:4px;" onclick="hapusRekening('${d.id}')">Hapus</button>
    </div>`;
  });
  const savedRi = localStorage.getItem('kostory_rek_sel');
  if (savedRi && rekeningList[savedRi]) document.getElementById('pilihRekening').value = savedRi;
  update();
}

window.tambahRekening = async () => {
  const nama = prompt("Nama Bank:");
  const nomor = prompt("Nomor Rekening:");
  const an = prompt("Atas Nama:");
  if (nama && nomor && an) {
    await addDoc(colRekening, {nama, nomor, atasNama: an});
    loadRekening();
  }
};

window.hapusRekening = async (id) => {
  if (confirm("Hapus rekening ini?")) {
    await deleteDoc(doc(db, "rekening", id));
    loadRekening();
  }
};

// Nomor Faktur
function getNomorFaktur() {
  const sekarang = new Date();
  const y = sekarang.getFullYear().toString().slice(-2);
  const m = String(sekarang.getMonth() + 1).padStart(2, '0');
  const key = `${y}${m}`;

  // Di Firebase, pakai atomic increment untuk menghindari bentrok
  const counterRef = doc(db, "counters", key);
  const snap = getDoc(counterRef);
  let n = snap.exists() ? snap.data().count || 0 : 0;
  n++;
  setDoc(counterRef, {count: n}, {merge: true});
  return key + String(n).padStart(3, '0');
}

// History
async function simpanKeHistory() {
  const newEntry = {
    no: document.getElementById('autoNo').textContent,
    tgl: document.getElementById('tglFaktur').value,
    perusahaan: document.getElementById('perusahaan').value.trim(),
    pic: document.getElementById('pic').value.trim(),
    hp: document.getElementById('hp').value.trim(),
    data: {
      perusahaan: document.getElementById('perusahaan').value,
      kota: document.getElementById('kota').value,
      hp: document.getElementById('hp').value,
      pic: document.getElementById('pic').value,
      tglFaktur: document.getElementById('tglFaktur').value,
      jatuhTempo: document.getElementById('jatuhTempo').value,
      tipe: document.getElementById('tipe').value,
      kamar: document.getElementById('kamar').value,
      in: document.getElementById('in').value,
      out: document.getElementById('out').value,
      tagihan: document.getElementById('tagihan').value,
      bayar: document.getElementById('bayar').value,
      tglBayar: document.getElementById('tglBayar').value,
      rekening: document.getElementById('pilihRekening').value
    },
    timestamp: serverTimestamp()
  };
  await addDoc(colHistory, newEntry);
  tampilkanHistory();
}

async function tampilkanHistory() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';

  const duaBulanLalu = new Date();
  duaBulanLalu.setMonth(duaBulanLalu.getMonth() - 2);

  const q = query(colHistory, where("tgl", ">=", duaBulanLalu.toISOString().slice(0,10)), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);

  if (snap.empty) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:30px;">Belum ada riwayat faktur dalam 2 bulan terakhir</td></tr>';
    return;
  }

  snap.forEach(d => {
    const h = d.data();
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${h.no}</td>
      <td>${t(h.tgl)}</td>
      <td>${h.perusahaan}</td>
      <td>${h.pic}</td>
      <td>${h.hp}</td>
      <td>
        <button class="action-btn btn-wa" onclick="shareWA('${h.hp.replace(/[^0-9]/g,'')}', '${h.no}')">WA</button>
        <button class="action-btn btn-delete" onclick="hapusHistory('${d.id}')">Hapus</button>
      </td>
    `;
    row.onclick = (e) => {
      if (e.target.tagName === 'BUTTON') return;
      loadHistoryKeForm(h.data);
    };
    tbody.appendChild(row);
  });
}

async function loadHistoryKeForm(data) {
  if (confirm('Edit faktur ini? Data form akan diganti.')) {
    document.getElementById('perusahaan').value = data.perusahaan || '';
    document.getElementById('kota').value = data.kota || '';
    document.getElementById('hp').value = data.hp || '';
    document.getElementById('pic').value = data.pic || '';
    document.getElementById('tglFaktur').value = data.tglFaktur || '';
    document.getElementById('jatuhTempo').value = data.jatuhTempo || '';
    document.getElementById('tipe').value = data.tipe || '';
    document.getElementById('kamar').value = data.kamar || '';
    document.getElementById('in').value = data.in || '';
    document.getElementById('out').value = data.out || '';
    document.getElementById('tagihan').value = data.tagihan || '';
    document.getElementById('bayar').value = data.bayar || '0';
    document.getElementById('tglBayar').value = data.tglBayar || '';
    document.getElementById('pilihRekening').value = data.rekening || '0';
    update();
  }
}

window.shareWA = (noHp, noFaktur) => {
  const tagihan = f(document.getElementById('tagihan').value);
  const text = encodeURIComponent(`*Kostory Invoice*\nNo. Faktur: ${noFaktur}\nTotal Tagihan: Rp${tagihan}\n\nTerima kasih!`);
  window.open(`https://wa.me/${noHp}?text=${text}`, '_blank');
};

async function hapusHistory(id) {
  if (confirm('Hapus faktur dari riwayat?')) {
    await deleteDoc(doc(db, "history", id));
    tampilkanHistory();
  }
}

// Backup (tetap pakai localStorage untuk backup, tapi data utama di Firebase)
window.exportBackup = () => {
  const data = {
    pelanggan: JSON.parse(localStorage.getItem('kostory_pelanggan') || '[]'), // fallback local
    history: JSON.parse(localStorage.getItem('kostory_history') || '[]'),
    rekeningList: JSON.parse(localStorage.getItem('kostory_rekening') || '[]'),
    counters: {}
  };
  const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
  saveAs(blob, "kostory_backup.json");
};

window.importBackup = (file) => {
  const r = new FileReader();
  r.onload = async (e) => {
    try {
      const d = JSON.parse(e.target.result);
      // Sync to Firebase
      const batch = writeBatch(db);
      d.pelanggan.forEach(p => batch.set(addDoc(colPelanggan), p));
      d.history.forEach(h => batch.set(addDoc(colHistory), h));
      d.rekeningList.forEach(r => batch.set(addDoc(colRekening), r));
      for (let k in d.counters) batch.set(doc(db, "counters", k), {count: d.counters[k]});
      await batch.commit();
      location.reload();
    } catch {alert('File tidak valid!');}
  };
  r.readAsText(file);
};

// Fungsi update & t & f sama seperti asli
const f = n => new Intl.NumberFormat('id-ID').format(n);
const t = d => new Date(d).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});

window.update = () => {
  const no = getNomorFaktur();
  document.getElementById('autoNo').textContent = document.getElementById('p-no').textContent = no;
  const tag = parseInt(document.getElementById('tagihan').value) || 0;
  const bay = parseInt(document.getElementById('bayar').value) || 0;
  const sisa = tag - bay;
  document.getElementById('p-perusahaan').textContent = (document.getElementById('perusahaan').value || "").toUpperCase();
  document.getElementById('p-kota').textContent = document.getElementById('kota').value;
  document.getElementById('p-hp').textContent = document.getElementById('hp').value;
  document.getElementById('p-pic').textContent = document.getElementById('pic').value;
  document.getElementById('p-tipe').textContent = document.getElementById('tipe').value;
  document.getElementById('p-kamar').textContent = document.getElementById('kamar').value;
  document.getElementById('p-periode').textContent = t(document.getElementById('in').value) + ' SD ' + t(document.getElementById('out').value);
  document.getElementById('p-tgl').textContent = t(document.getElementById('tglFaktur').value);
  document.getElementById('p-tempo').textContent = t(document.getElementById('jatuhTempo').value);
  ['p-harga','p-jumlah','p-subtotal','p-total2'].forEach(id => document.getElementById(id).textContent = f(tag));
  document.getElementById('p-bayar').textContent = f(bay);
  document.getElementById('p-sisa').textContent = f(sisa);
  document.getElementById('p-infoBayar').textContent = document.getElementById('tglBayar').value ? "Tanggal " + t(document.getElementById('tglBayar').value) + " - Rp" + f(bay) : "(Belum ada pembayaran)";
  const ri = document.getElementById('pilihRekening').value;
  if (rekeningList[ri]) {
    const r = rekeningList[ri];
    document.getElementById('p-rekening').innerHTML = `${r.nama}<br>${r.nomor}<br>${r.atasNama}`;
    localStorage.setItem('kostory_rek_sel', ri);
  }
};

// Init
loadPelanggan();
loadRekening();
tampilkanHistory();
document.querySelectorAll('input,select').forEach(el => {
  el.addEventListener('input', update);
  el.addEventListener('change', update);
});
update();
</script>
</body>
</html>
